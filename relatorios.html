<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios - Fortimed SAC</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <!-- Bibliotecas para Relat√≥rios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <img src="/img/logo.png" alt="Fortimed Logo" class="logo" onerror="this.style.display='none'">
                    <h1>üìä Relat√≥rios - Fortimed SAC</h1>
                </div>
                <div class="user-info" id="userInfo">
                    <span id="userName"></span>
                    <button onclick="goBack()" class="btn-secondary">‚Üê Voltar</button>
                    <button onclick="logout()" class="btn-secondary">Sair</button>
                </div>
            </div>
        </header>

        <main class="config-page">
            <div class="form-container">
                <h2>üìä Gera√ß√£o de Relat√≥rios</h2>
                <p class="info">Exporte todos os chamados cadastrados em diferentes formatos:</p>
                
                <div class="reports-grid">
                    <div class="report-card">
                        <h4>üìã Relat√≥rio Excel</h4>
                        <p>Exportar em formato .XLSX com todas as colunas</p>
                        <button onclick="generateExcelReport()" class="btn-primary btn-full">üì• Baixar Excel</button>
                    </div>

                    <div class="report-card">
                        <h4>üìÑ Relat√≥rio PDF</h4>
                        <p>Documento formatado em PDF pronto para impress√£o</p>
                        <button onclick="generatePDFReport()" class="btn-primary btn-full">üì• Baixar PDF</button>
                    </div>

                    <div class="report-card">
                        <h4>üìù Relat√≥rio CSV</h4>
                        <p>Arquivo CSV compat√≠vel com planilhas</p>
                        <button onclick="generateCSVReport()" class="btn-primary btn-full">üì• Baixar CSV</button>
                    </div>

                    <div class="report-card">
                        <h4>üìä Relat√≥rio JSON</h4>
                        <p>Dados estruturados em formato JSON</p>
                        <button onclick="generateJSONReport()" class="btn-primary btn-full">üì• Baixar JSON</button>
                    </div>
                </div>

                <div class="report-filters">
                    <h4>‚öôÔ∏è Filtros de Relat√≥rio (Opcional)</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label for="filterStatus">Filtrar por Status:</label>
                            <select id="filterStatus">
                                <option value="">Todos os status</option>
                                <option value="aberto">Aberto</option>
                                <option value="em_andamento">Em Andamento</option>
                                <option value="aguardando_transportadora">Aguardando Transportadora</option>
                                <option value="fechado">Fechado</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="filterMotivo">Filtrar por Motivo:</label>
                            <select id="filterMotivo">
                                <option value="">Todos os motivos</option>
                                <option value="cotacao_errada_comercial">Cota√ß√£o feita errada pelo comercial</option>
                                <option value="cotacao_errada_compras">Cota√ß√£o feita errada pelo compras</option>
                                <option value="validade_curta">Validade curta</option>
                                <option value="divergencia_transportadora">Itens com diverg√™ncia pela transportadora</option>
                                <option value="envio_errado_logistica">Itens com envio errado pela log√≠stica</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="reportDateFrom">Data Inicial:</label>
                            <input type="date" id="reportDateFrom">
                        </div>

                        <div class="form-group">
                            <label for="reportDateTo">Data Final:</label>
                            <input type="date" id="reportDateTo">
                        </div>

                        <div class="form-group">
                            <label for="reportUser">Filtrar por Usu√°rio:</label>
                            <input type="text" id="reportUser" placeholder="Deixe vazio para todos">
                        </div>
                    </div>
                </div>

                <div id="reportStatusMessage" class="report-status"></div>

                <!-- Preview da Tabela -->
                <div style="display: flex; gap: 10px; margin: 20px 0;">
                    <button onclick="loadPreviewTable()" class="btn-primary" style="flex: 1;">üëÅÔ∏è Visualizar Pr√©via</button>
                    <button onclick="clearPreview()" class="btn-secondary" style="flex: 1;">üîÑ Limpar Pr√©via</button>
                </div>

                <!-- Tabela de Preview -->
                <div id="reportPreviewContainer" style="display: none;">
                    <div style="overflow-x: auto; border: 1px solid #e9d5ff; border-radius: 8px; margin-top: 15px;">
                        <table class="report-preview-table" id="reportPreviewTable">
                            <thead id="previewTableHead"></thead>
                            <tbody id="previewTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        // Fun√ß√£o para voltar
        function goBack() {
            window.location.href = '/index.html';
        }

        // ============================================================================
        // FUN√á√ïES DE RELAT√ìRIO
        // ============================================================================

        // Carregar dados dos chamados com filtros
        async function loadReportData() {
            try {
                const client = config.getClient();
                
                // Verificar autentica√ß√£o
                const { data: { session } } = await client.auth.getSession();
                if (!session) {
                    throw new Error('Voc√™ precisa estar logado para gerar relat√≥rios');
                }

                // Verificar se √© admin
                const currentUser = authManager.getCurrentUser();
                const isAdmin = currentUser && currentUser.role === 'admin';

                // Buscar dados
                const { data, error } = await client
                    .from('occurrences')
                    .select(`
                        *,
                        users!created_by(name)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Aplicar filtros
                let filteredData = data || [];

                // Filtro 1: Acesso (admin vs user)
                if (!isAdmin) {
                    filteredData = filteredData.filter(occ => occ.created_by === session.user.id);
                }

                // Filtro 2: Status
                const statusFilter = document.getElementById('filterStatus').value;
                if (statusFilter) {
                    filteredData = filteredData.filter(occ => occ.status === statusFilter);
                }

                // Filtro 3: Motivo
                const motivoFilter = document.getElementById('filterMotivo').value;
                if (motivoFilter) {
                    filteredData = filteredData.filter(occ => occ.motivo === motivoFilter);
                }

                // Filtro 4: Data Inicial
                const dateFrom = document.getElementById('reportDateFrom').value;
                if (dateFrom) {
                    const fromDate = new Date(dateFrom);
                    filteredData = filteredData.filter(occ => new Date(occ.created_at) >= fromDate);
                }

                // Filtro 5: Data Final
                const dateTo = document.getElementById('reportDateTo').value;
                if (dateTo) {
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59);
                    filteredData = filteredData.filter(occ => new Date(occ.created_at) <= toDate);
                }

                // Filtro 6: Usu√°rio
                const userFilter = document.getElementById('reportUser').value.toLowerCase();
                if (userFilter) {
                    filteredData = filteredData.filter(occ => 
                        (occ.users?.name || '').toLowerCase().includes(userFilter)
                    );
                }

                return filteredData;

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showReportStatus(`‚ùå Erro: ${error.message}`, 'error');
                throw error;
            }
        }

        // Mostrar status do relat√≥rio
        function showReportStatus(message, type) {
            const statusDiv = document.getElementById('reportStatusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `report-status ${type}`;
        }

        // ========== FUN√á√ïES DE PREVIEW ==========
        async function loadPreviewTable() {
            try {
                const data = await loadReportData();
                
                if (!data || data.length === 0) {
                    showReportStatus('‚ùå Nenhum dado encontrado com os filtros aplicados', 'error');
                    return;
                }

                // Headers
                const headers = [
                    'N¬∫ Pedido', 'NF', 'Transportadora', 'Cliente', 
                    'Ocorr√™ncia', 'Motivo', 'Status', 'Situa√ß√£o',
                    'Resp. Falha', 'Resp. Resolu√ß√£o', 'Criado em', 'Atualizado em'
                ];

                // Montar header
                const thead = document.getElementById('previewTableHead');
                thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';

                // Montar body
                const tbody = document.getElementById('previewTableBody');
                tbody.innerHTML = data.map(occ => `
                    <tr>
                        <td>${occ.num_pedido || '-'}</td>
                        <td>${occ.nota_fiscal || '-'}</td>
                        <td>${occ.transportadora || '-'}</td>
                        <td>${occ.nome_cliente || '-'}</td>
                        <td title="${occ.ocorrencia || ''}">${occ.ocorrencia ? (occ.ocorrencia.length > 20 ? occ.ocorrencia.substring(0, 20) + '...' : occ.ocorrencia) : '-'}</td>
                        <td>${occ.motivo || '-'}</td>
                        <td><span class="status status-${occ.status}">${occ.status || '-'}</span></td>
                        <td title="${occ.situacao || ''}">${occ.situacao ? (occ.situacao.length > 15 ? occ.situacao.substring(0, 15) + '...' : occ.situacao) : '-'}</td>
                        <td>${occ.responsavel_falha || '-'}</td>
                        <td>${occ.responsavel_resolucao || '-'}</td>
                        <td>${new Date(occ.created_at).toLocaleDateString('pt-BR')}</td>
                        <td>${occ.updated_at ? new Date(occ.updated_at).toLocaleDateString('pt-BR') : '-'}</td>
                    </tr>
                `).join('');

                // Mostrar container
                document.getElementById('reportPreviewContainer').style.display = 'block';
                showReportStatus(`‚úÖ Pr√©via carregada com ${data.length} registro(s)`, 'success');

            } catch (error) {
                console.error('Erro ao carregar pr√©via:', error);
                showReportStatus(`‚ùå Erro ao carregar pr√©via: ${error.message}`, 'error');
            }
        }

        function clearPreview() {
            document.getElementById('reportPreviewContainer').style.display = 'none';
            document.getElementById('previewTableHead').innerHTML = '';
            document.getElementById('previewTableBody').innerHTML = '';
            showReportStatus('‚ú® Pr√©via limpa', 'success');
        }

        // Gerar Relat√≥rio Excel
        async function generateExcelReport() {
            try {
                showReportStatus('üîÑ Gerando relat√≥rio Excel...', 'loading');
                
                const data = await loadReportData();

                if (data.length === 0) {
                    showReportStatus('‚ö†Ô∏è Nenhum dado encontrado para o relat√≥rio', 'error');
                    return;
                }

                // Executar exporta√ß√£o diretamente (biblioteca j√° carregada no HEAD)
                executeExcelExport(data);

            } catch (error) {
                console.error('Erro ao gerar Excel:', error);
                showReportStatus(`‚ùå Erro ao gerar relat√≥rio: ${error.message}`, 'error');
            }
        }

        function executeExcelExport(data) {
            try {
                // Preparar dados
                const exportData = data.map(occ => ({
                    'N¬∫ Pedido': occ.num_pedido,
                    'Nota Fiscal': occ.nota_fiscal || '-',
                    'Transportadora': occ.transportadora,
                    'Cliente': occ.nome_cliente,
                    'Descri√ß√£o': occ.ocorrencia,
                    'Status': occ.status,
                    'Situa√ß√£o': occ.situacao || '-',
                    'Criado Por': occ.users?.name || 'Desconhecido',
                    'Data': new Date(occ.created_at).toLocaleString('pt-BR')
                }));

                // Criar workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Ajustar largura das colunas
                const colWidths = [12, 14, 18, 18, 30, 12, 20, 18, 18];
                ws['!cols'] = colWidths.map(w => ({ wch: w }));
                
                XLSX.utils.book_append_sheet(wb, ws, 'Ocorr√™ncias');
                
                // Baixar arquivo
                const timestamp = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(wb, `Relatorio_Chamados_${timestamp}.xlsx`);

                showReportStatus(`‚úÖ Relat√≥rio Excel gerado com sucesso! (${data.length} registros)`, 'success');

            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                showReportStatus(`‚ùå Erro ao exportar: ${error.message}`, 'error');
            }
        }

        // Gerar Relat√≥rio PDF
        async function generatePDFReport() {
            try {
                showReportStatus('üîÑ Gerando relat√≥rio PDF...', 'loading');
                
                const data = await loadReportData();

                if (data.length === 0) {
                    showReportStatus('‚ö†Ô∏è Nenhum dado encontrado para o relat√≥rio', 'error');
                    return;
                }

                // Executar exporta√ß√£o diretamente (bibliotecas j√° carregadas no HEAD)
                executePDFExport(data);

            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showReportStatus(`‚ùå Erro ao gerar relat√≥rio: ${error.message}`, 'error');
            }
        }

        function executePDFExport(data) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4'); // Landscape para acomodar mais colunas

                // T√≠tulo
                doc.setFontSize(16);
                doc.text('Relat√≥rio de Ocorr√™ncias - Fortimed SAC', 14, 15);

                // Data e total
                doc.setFontSize(10);
                doc.text(`Data: ${new Date().toLocaleString('pt-BR')}`, 14, 22);
                doc.text(`Total de registros: ${data.length}`, 14, 28);

                // Preparar dados para tabela com TODOS os campos
                const tableData = data.map(occ => [
                    occ.num_pedido || '-',
                    occ.nota_fiscal || '-',
                    occ.transportadora || '-',
                    occ.nome_cliente || '-',
                    occ.ocorrencia ? occ.ocorrencia.substring(0, 30) + '...' : '-',
                    occ.motivo || '-',
                    occ.status || '-',
                    occ.situacao ? occ.situacao.substring(0, 20) + '...' : '-',
                    occ.responsavel_falha || '-',
                    occ.responsavel_resolucao || '-',
                    new Date(occ.created_at).toLocaleDateString('pt-BR'),
                    occ.updated_at ? new Date(occ.updated_at).toLocaleDateString('pt-BR') : '-'
                ]);

                // Tabela com todas as colunas
                doc.autoTable({
                    head: [[
                        'N¬∫ Pedido',
                        'NF',
                        'Transportadora',
                        'Cliente',
                        'Ocorr√™ncia',
                        'Motivo',
                        'Status',
                        'Situa√ß√£o',
                        'Resp. Falha',
                        'Resp. Resolu√ß√£o',
                        'Criado em',
                        'Atualizado em'
                    ]],
                    body: tableData,
                    startY: 35,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [37, 99, 235], 
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        cellPadding: 3
                    },
                    bodyStyles: { 
                        textColor: [50, 50, 50],
                        fontSize: 8,
                        cellPadding: 2
                    },
                    columnStyles: {
                        0: { cellWidth: 18 },  // N¬∫ Pedido
                        1: { cellWidth: 16 },  // NF
                        2: { cellWidth: 22 },  // Transportadora
                        3: { cellWidth: 20 },  // Cliente
                        4: { cellWidth: 25 },  // Ocorr√™ncia
                        5: { cellWidth: 18 },  // Motivo
                        6: { cellWidth: 16 },  // Status
                        7: { cellWidth: 18 },  // Situa√ß√£o
                        8: { cellWidth: 16 },  // Resp. Falha
                        9: { cellWidth: 18 },  // Resp. Resolu√ß√£o
                        10: { cellWidth: 18 }, // Criado em
                        11: { cellWidth: 18 }  // Atualizado em
                    },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    didDrawPage: (data) => {
                        // Rodap√© em cada p√°gina
                        const pageCount = doc.getNumberOfPages();
                        const pageSize = doc.internal.pageSize;
                        const pageHeight = pageSize.getHeight();
                        const pageWidth = pageSize.getWidth();
                        const currentPage = doc.internal.pages.length - 1;
                        
                        doc.setFontSize(8);
                        doc.text(
                            `P√°gina ${currentPage} de ${pageCount}`,
                            pageWidth - 15,
                            pageHeight - 10,
                            { align: 'right' }
                        );
                    }
                });

                // Baixar
                const timestamp = new Date().toISOString().slice(0, 10);
                doc.save(`Relatorio_Ocorrencias_${timestamp}.pdf`);

                showReportStatus(`‚úÖ Relat√≥rio PDF gerado com sucesso! (${data.length} registros)`, 'success');

            } catch (error) {
                console.error('Erro ao exportar PDF:', error);
                showReportStatus(`‚ùå Erro ao exportar: ${error.message}`, 'error');
            }
        }

        // Gerar Relat√≥rio CSV
        async function generateCSVReport() {
            try {
                showReportStatus('üîÑ Gerando relat√≥rio CSV...', 'loading');
                
                const data = await loadReportData();

                if (data.length === 0) {
                    showReportStatus('‚ö†Ô∏è Nenhum dado encontrado para o relat√≥rio', 'error');
                    return;
                }

                // Preparar dados
                const headers = ['N¬∫ Pedido', 'Nota Fiscal', 'Transportadora', 'Cliente', 'Descri√ß√£o', 'Status', 'Situa√ß√£o', 'Criado Por', 'Data'];
                const rows = data.map(occ => [
                    escapeCSV(occ.num_pedido),
                    escapeCSV(occ.nota_fiscal || '-'),
                    escapeCSV(occ.transportadora),
                    escapeCSV(occ.nome_cliente),
                    escapeCSV(occ.ocorrencia),
                    escapeCSV(occ.status),
                    escapeCSV(occ.situacao || '-'),
                    escapeCSV(occ.users?.name || 'Desconhecido'),
                    new Date(occ.created_at).toLocaleString('pt-BR')
                ]);

                // Montar CSV
                let csv = headers.join(',') + '\n';
                csv += rows.map(row => row.join(',')).join('\n');

                // Baixar
                downloadFile(csv, 'text/csv', `Relatorio_Chamados_${new Date().toISOString().slice(0, 10)}.csv`);

                showReportStatus(`‚úÖ Relat√≥rio CSV gerado com sucesso! (${data.length} registros)`, 'success');

            } catch (error) {
                console.error('Erro ao gerar CSV:', error);
                showReportStatus(`‚ùå Erro ao gerar relat√≥rio: ${error.message}`, 'error');
            }
        }

        // Gerar Relat√≥rio JSON
        async function generateJSONReport() {
            try {
                showReportStatus('üîÑ Gerando relat√≥rio JSON...', 'loading');
                
                const data = await loadReportData();

                if (data.length === 0) {
                    showReportStatus('‚ö†Ô∏è Nenhum dado encontrado para o relat√≥rio', 'error');
                    return;
                }

                // Estruturar dados
                const report = {
                    titulo: 'Relat√≥rio de Chamados - Fortimed',
                    dataGeracao: new Date().toLocaleString('pt-BR'),
                    totalRegistros: data.length,
                    chamados: data.map(occ => ({
                        numeroPedido: occ.num_pedido,
                        notaFiscal: occ.nota_fiscal || null,
                        transportadora: occ.transportadora,
                        cliente: occ.nome_cliente,
                        descricao: occ.ocorrencia,
                        status: occ.status,
                        situacao: occ.situacao || null,
                        criadoPor: occ.users?.name || 'Desconhecido',
                        dataCriacao: new Date(occ.created_at).toISOString(),
                        dataUltimaAlteracao: new Date(occ.updated_at).toISOString()
                    }))
                };

                // Converter para JSON
                const jsonString = JSON.stringify(report, null, 2);

                // Baixar
                downloadFile(jsonString, 'application/json', `Relatorio_Chamados_${new Date().toISOString().slice(0, 10)}.json`);

                showReportStatus(`‚úÖ Relat√≥rio JSON gerado com sucesso! (${data.length} registros)`, 'success');

            } catch (error) {
                console.error('Erro ao gerar JSON:', error);
                showReportStatus(`‚ùå Erro ao gerar relat√≥rio: ${error.message}`, 'error');
            }
        }

        // Fun√ß√£o auxiliar: escapar CSV
        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const stringValue = String(value);
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                return '"' + stringValue.replace(/"/g, '""') + '"';
            }
            return stringValue;
        }

        // Fun√ß√£o auxiliar: baixar arquivo
        function downloadFile(content, mimeType, filename) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:' + mimeType + ';charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
    </script>
</body>
</html>
