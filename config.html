<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes - Fortimed SAC</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <!-- Bibliotecas para Relat√≥rios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <img src="img/logo.png" alt="Fortimed Logo" class="logo">
                    <h1>‚öôÔ∏è Configura√ß√µes - Fortimed SAC</h1>
                </div>
                <div class="user-info" id="userInfo">
                    <span id="userName"></span>
                    <button onclick="goBack()" class="btn-secondary">‚Üê Voltar</button>
                    <button onclick="logout()" class="btn-secondary">Sair</button>
                </div>
            </div>
        </header>

        <main class="config-page">
            <div class="form-container">
                <h2>‚öôÔ∏è Configura√ß√µes do Supabase</h2>
                <p class="info">Credenciais do banco de dados (somente leitura - sistema pr√©-configurado)</p>
                
                <form id="configForm" onsubmit="saveConfig(event)">
                    <div class="form-group">
                        <label for="supabaseUrl">Supabase URL:</label>
                        <input type="url" id="supabaseUrl" readonly placeholder="https://iowfcilmbeynrfszqlhu.supabase.co">
                        <small>URL do projeto Supabase</small>
                    </div>

                    <div class="form-group">
                        <label for="supabaseKey">Supabase Anon Key:</label>
                        <input type="password" id="supabaseKey" readonly placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <small>Chave p√∫blica do Supabase (mascarada por seguran√ßa)</small>
                    </div>

                    <div class="form-actions">
                        <button type="button" onclick="testConnection()" class="btn-primary">üîå Testar Conex√£o</button>
                        <button type="button" onclick="loadConfig()" class="btn-secondary">üì• Carregar Configura√ß√µes</button>
                        <button type="button" onclick="goBack()" class="btn-secondary">‚Üê Voltar</button>
                    </div>
                </form>

                <div id="testResult" class="test-result"></div>

                <!-- Se√ß√£o de Informa√ß√µes do Banco -->
                <div class="database-info">
                    <h3>üìä Estrutura do Banco de Dados</h3>
                    <p>Se voc√™ precisa recriar as tabelas, execute este SQL no seu Supabase SQL Editor:</p>
                    
                    <div class="sql-section">
                        <h4>‚úÖ Setup Recomendado (Executar no Supabase):</h4>
                        <button onclick="copySetupSQL()" class="btn-secondary btn-sm">üìã Copiar Setup</button>
                        <pre><code id="setupSQL">-- ============================================================================
-- FORTIMED - CONFIGURA√á√ÉO SIMPLIFICADA DO BANCO DE DADOS
-- Execute este script no Supabase SQL Editor
-- ============================================================================

-- 1. Criar tabela de usu√°rios para controle de roles
CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    role VARCHAR(50) DEFAULT 'user',
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. Criar tabela de ocorr√™ncias
CREATE TABLE IF NOT EXISTS occurrences (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    num_pedido VARCHAR(100) NOT NULL,
    nota_fiscal VARCHAR(100),
    transportadora VARCHAR(255) NOT NULL,
    nome_cliente VARCHAR(255) NOT NULL,
    ocorrencia TEXT NOT NULL,
    status VARCHAR(50) NOT NULL,
    situacao TEXT,
    responsavel_falha VARCHAR(255),
    responsavel_resolucao VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    created_by UUID REFERENCES users(id)
);

-- 3. Habilitar RLS na tabela occurrences
ALTER TABLE occurrences ENABLE ROW LEVEL SECURITY;

-- 4. Remover todas as pol√≠ticas existentes
DROP POLICY IF EXISTS "Usu√°rios veem apenas suas ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios podem criar ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios atualizam apenas suas ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios deletam apenas suas ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Admin v√™ todas as ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios veem suas pr√≥prias ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Admin pode fazer qualquer coisa" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios autenticados podem ver ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios autenticados podem criar ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios autenticados podem atualizar ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios autenticados podem deletar ocorr√™ncias" ON occurrences;

-- 5. Criar pol√≠ticas RLS com controle de admin
-- Admin pode ver todas as ocorr√™ncias
CREATE POLICY "Admin v√™ todas as ocorr√™ncias"
    ON occurrences FOR SELECT
    USING (
        EXISTS(
            SELECT 1 FROM users
            WHERE users.id = auth.uid()
            AND users.role = 'admin'
        )
    );

-- Usu√°rios normais veem apenas suas ocorr√™ncias
CREATE POLICY "Usu√°rios veem suas pr√≥prias ocorr√™ncias"
    ON occurrences FOR SELECT
    USING (created_by = auth.uid());

-- Permitir inser√ß√£o para usu√°rios autenticados
CREATE POLICY "Usu√°rios autenticados podem criar ocorr√™ncias"
    ON occurrences FOR INSERT
    WITH CHECK (auth.role() = 'authenticated');

-- Permitir atualiza√ß√£o para admin ou criador
CREATE POLICY "Usu√°rios e admin podem atualizar ocorr√™ncias"
    ON occurrences FOR UPDATE
    USING (
        created_by = auth.uid() OR
        EXISTS(
            SELECT 1 FROM users
            WHERE users.id = auth.uid()
            AND users.role = 'admin'
        )
    );

-- Permitir deleta√ß√£o para admin ou criador
CREATE POLICY "Usu√°rios e admin podem deletar ocorr√™ncias"
    ON occurrences FOR DELETE
    USING (
        created_by = auth.uid() OR
        EXISTS(
            SELECT 1 FROM users
            WHERE users.id = auth.uid()
            AND users.role = 'admin'
        )
    );

-- 6. Criar √≠ndices para melhor performance
CREATE INDEX IF NOT EXISTS idx_occurrences_num_pedido ON occurrences(num_pedido);
CREATE INDEX IF NOT EXISTS idx_occurrences_status ON occurrences(status);
CREATE INDEX IF NOT EXISTS idx_occurrences_created_at ON occurrences(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_occurrences_created_by ON occurrences(created_by);
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);

-- ============================================================================
-- FORTIMED DATABASE SETUP COMPLETE ‚úÖ
-- ============================================================================</code></pre>
                    </div>

                    <!-- Se√ß√£o de Limpeza de Duplicatas -->
                    <div class="sql-section">
                        <h4>üßπ Limpar Duplicatas (se necess√°rio):</h4>
                        <button onclick="copyCleanupSQL()" class="btn-secondary btn-sm">üìã Copiar Limpeza</button>
                        <pre><code id="cleanupSQL">-- Remove ocorr√™ncias duplicadas, mantendo apenas a mais recente
DELETE FROM occurrences
WHERE id NOT IN (
    SELECT MAX(id) FROM occurrences
    GROUP BY num_pedido, nome_cliente, transportadora
);

-- Verifica resultado
SELECT COUNT(*) as total_occurrences FROM occurrences;</code></pre>
                    </div>

                    <!-- Se√ß√£o de Admin -->
                    <div class="sql-section">
                        <h4>üëë Configurar Admin (se necess√°rio):</h4>
                        <button onclick="copyAdminSQL()" class="btn-secondary btn-sm">üìã Copiar Admin</button>
                        <pre><code id="adminSQL">-- Atualizar um usu√°rio para admin
UPDATE users
SET role = 'admin'
WHERE email = 'administrativo@fortimeddistribuidora.com.br';

-- Verificar usu√°rios e roles
SELECT id, email, name, role, created_at FROM users ORDER BY created_at DESC;</code></pre>
                    </div>
                </div>

                <!-- Status do Sistema -->
                <div class="system-status">
                    <h3>üîç Status do Sistema</h3>
                    <div id="statusInfo" class="status-list">
                        <p>Carregando informa√ß√µes...</p>
                    </div>
                </div>

                <!-- Se√ß√£o de Relat√≥rios -->
                <div class="reports-section">
                    <h3>üìä Gera√ß√£o de Relat√≥rios</h3>
                    <p class="info">Exporte todos os chamados cadastrados em diferentes formatos:</p>
                    
                    <div class="reports-grid">
                        <div class="report-card">
                            <h4>üìã Relat√≥rio Excel</h4>
                            <p>Exportar em formato .XLSX com todas as colunas</p>
                            <button onclick="generateExcelReport()" class="btn-primary btn-full">üì• Baixar Excel</button>
                        </div>

                        <div class="report-card">
                            <h4>üìÑ Relat√≥rio PDF</h4>
                            <p>Documento formatado em PDF pronto para impress√£o</p>
                            <button onclick="generatePDFReport()" class="btn-primary btn-full">üì• Baixar PDF</button>
                        </div>

                        <div class="report-card">
                            <h4>üìù Relat√≥rio CSV</h4>
                            <p>Arquivo CSV compat√≠vel com planilhas</p>
                            <button onclick="generateCSVReport()" class="btn-primary btn-full">üì• Baixar CSV</button>
                        </div>

                        <div class="report-card">
                            <h4>üìä Relat√≥rio JSON</h4>
                            <p>Dados estruturados em formato JSON</p>
                            <button onclick="generateJSONReport()" class="btn-primary btn-full">üì• Baixar JSON</button>
                        </div>
                    </div>

                    <div class="report-filters">
                        <h4>‚öôÔ∏è Filtros de Relat√≥rio (Opcional)</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="filterStatus">Filtrar por Status:</label>
                                <select id="filterStatus">
                                    <option value="">Todos os status</option>
                                    <option value="Aberto">Aberto</option>
                                    <option value="Em An√°lise">Em An√°lise</option>
                                    <option value="Resolvido">Resolvido</option>
                                    <option value="Fechado">Fechado</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="reportDateFrom">Data Inicial:</label>
                                <input type="date" id="reportDateFrom">
                            </div>

                            <div class="form-group">
                                <label for="reportDateTo">Data Final:</label>
                                <input type="date" id="reportDateTo">
                            </div>

                            <div class="form-group">
                                <label for="reportUser">Filtrar por Usu√°rio:</label>
                                <input type="text" id="reportUser" placeholder="Deixe vazio para todos">
                            </div>
                        </div>
                    </div>

                    <div id="reportStatusMessage" class="report-status"></div>
                </div>

                <!-- Informa√ß√µes √öteis -->
                <div class="helpful-info">
                    <h3>‚ÑπÔ∏è Informa√ß√µes √öteis</h3>
                    <ul>
                        <li><strong>Usu√°rios Padr√£o:</strong>
                            <ul>
                                <li>Admin: administrativo@fortimeddistribuidora.com.br (Compras@01)</li>
                                <li>Vendas: vendas01@fortimeddistribuidora.com.br at√© vendas06@</li>
                            </ul>
                        </li>
                        <li><strong>Funcionalidades:</strong>
                            <ul>
                                <li>Admin v√™ todos os chamados</li>
                                <li>Usu√°rios normais veem apenas seus chamados</li>
                                <li>Cria√ß√£o, edi√ß√£o e exclus√£o de ocorr√™ncias</li>
                                <li>Filtros e busca por n√∫mero do pedido, cliente ou transportadora</li>
                            </ul>
                        </li>
                        <li><strong>Documenta√ß√£o:</strong>
                            <ul>
                                <li>Solu√ß√£o R√°pida: <code>SOLUCAO-RAPIDA.md</code></li>
                                <li>Solu√ß√£o Admin: <code>SOLUCAO-ADMIN.md</code></li>
                                <li>README Principal: <code>README.md</code></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        // Fun√ß√£o para voltar
        function goBack() {
            window.location.href = 'index.html';
        }

        // ============================================================================
        // FUN√á√ïES DE RELAT√ìRIO
        // ============================================================================

        // Carregar dados dos chamados com filtros
        async function loadReportData() {
            try {
                const client = config.getClient();
                
                // Verificar autentica√ß√£o
                const { data: { session } } = await client.auth.getSession();
                if (!session) {
                    throw new Error('Voc√™ precisa estar logado para gerar relat√≥rios');
                }

                // Verificar se √© admin
                const currentUser = authManager.getCurrentUser();
                const isAdmin = currentUser && currentUser.role === 'admin';

                // Buscar dados
                const { data, error } = await client
                    .from('occurrences')
                    .select(`
                        *,
                        users!created_by(name)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Aplicar filtros
                let filteredData = data || [];

                // Filtro 1: Acesso (admin vs user)
                if (!isAdmin) {
                    filteredData = filteredData.filter(occ => occ.created_by === session.user.id);
                }

                // Filtro 2: Status
                const statusFilter = document.getElementById('filterStatus').value;
                if (statusFilter) {
                    filteredData = filteredData.filter(occ => occ.status === statusFilter);
                }

                // Filtro 3: Data Inicial
                const dateFrom = document.getElementById('reportDateFrom').value;
                if (dateFrom) {
                    const fromDate = new Date(dateFrom);
                    filteredData = filteredData.filter(occ => new Date(occ.created_at) >= fromDate);
                }

                // Filtro 4: Data Final
                const dateTo = document.getElementById('reportDateTo').value;
                if (dateTo) {
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59);
                    filteredData = filteredData.filter(occ => new Date(occ.created_at) <= toDate);
                }

                // Filtro 5: Usu√°rio
                const userFilter = document.getElementById('reportUser').value.toLowerCase();
                if (userFilter) {
                    filteredData = filteredData.filter(occ => 
                        (occ.users?.name || '').toLowerCase().includes(userFilter)
                    );
                }

                return filteredData;

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showReportStatus(`‚ùå Erro: ${error.message}`, 'error');
                throw error;
            }
        }

        // Mostrar status do relat√≥rio
        function showReportStatus(message, type) {
            const statusDiv = document.getElementById('reportStatusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `report-status ${type}`;
        }

        // Gerar Relat√≥rio Excel
        async function generateExcelReport() {
            try {
                showReportStatus('üîÑ Gerando relat√≥rio Excel...', 'loading');
                
                const data = await loadReportData();

                if (data.length === 0) {
                    showReportStatus('‚ö†Ô∏è Nenhum dado encontrado para o relat√≥rio', 'error');
                    return;
                }

                // Executar exporta√ß√£o diretamente (biblioteca j√° carregada no HEAD)
                executeExcelExport(data);

            } catch (error) {
                console.error('Erro ao gerar Excel:', error);
                showReportStatus(`‚ùå Erro ao gerar relat√≥rio: ${error.message}`, 'error');
            }
        }

        function executeExcelExport(data) {
            try {
                // Preparar dados
                const exportData = data.map(occ => ({
                    'N¬∫ Pedido': occ.num_pedido,
                    'Nota Fiscal': occ.nota_fiscal || '-',
                    'Transportadora': occ.transportadora,
                    'Cliente': occ.nome_cliente,
                    'Descri√ß√£o': occ.ocorrencia,
                    'Status': occ.status,
                    'Situa√ß√£o': occ.situacao || '-',
                    'Respons√°vel Falha': occ.responsavel_falha || '-',
                    'Respons√°vel Resolu√ß√£o': occ.responsavel_resolucao || '-',
                    'Criado Por': occ.users?.name || 'Desconhecido',
                    'Data': new Date(occ.created_at).toLocaleString('pt-BR')
                }));

                // Criar workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Ajustar largura das colunas
                const colWidths = [12, 14, 18, 18, 30, 12, 20, 18, 20, 18, 18];
                ws['!cols'] = colWidths.map(w => ({ wch: w }));
                
                XLSX.utils.book_append_sheet(wb, ws, 'Ocorr√™ncias');
                
                // Baixar arquivo
                const timestamp = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(wb, `Relatorio_Chamados_${timestamp}.xlsx`);

                showReportStatus(`‚úÖ Relat√≥rio Excel gerado com sucesso! (${data.length} registros)`, 'success');

            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                showReportStatus(`‚ùå Erro ao exportar: ${error.message}`, 'error');
            }
        }

        // Gerar Relat√≥rio PDF
        async function generatePDFReport() {
            try {
                showReportStatus('üîÑ Gerando relat√≥rio PDF...', 'loading');
                
                const data = await loadReportData();

                if (data.length === 0) {
                    showReportStatus('‚ö†Ô∏è Nenhum dado encontrado para o relat√≥rio', 'error');
                    return;
                }

                // Executar exporta√ß√£o diretamente (bibliotecas j√° carregadas no HEAD)
                executePDFExport(data);

            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showReportStatus(`‚ùå Erro ao gerar relat√≥rio: ${error.message}`, 'error');
            }
        }

        function executePDFExport(data) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // T√≠tulo
                doc.setFontSize(16);
                doc.text('Relat√≥rio de Chamados - Fortimed', 14, 15);

                // Data
                doc.setFontSize(10);
                doc.text(`Data: ${new Date().toLocaleString('pt-BR')}`, 14, 22);
                doc.text(`Total de registros: ${data.length}`, 14, 28);

                // Preparar dados para tabela
                const tableData = data.map(occ => [
                    occ.num_pedido,
                    occ.transportadora,
                    occ.nome_cliente,
                    occ.status,
                    new Date(occ.created_at).toLocaleDateString('pt-BR')
                ]);

                // Tabela
                doc.autoTable({
                    head: [['N¬∫ Pedido', 'Transportadora', 'Cliente', 'Status', 'Data']],
                    body: tableData,
                    startY: 35,
                    theme: 'grid',
                    headStyles: { fillColor: [37, 99, 235], textColor: [255, 255, 255] },
                    bodyStyles: { textColor: [50, 50, 50] },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    didDrawPage: (data) => {
                        // Rodap√© em cada p√°gina
                        const pageCount = doc.getNumberOfPages();
                        const pageSize = doc.internal.pageSize;
                        const pageHeight = pageSize.getHeight();
                        const pageWidth = pageSize.getWidth();
                        const currentPage = doc.internal.pages.length - 1;
                        
                        doc.setFontSize(8);
                        doc.text(
                            `P√°gina ${currentPage} de ${pageCount}`,
                            pageWidth - 20,
                            pageHeight - 10,
                            { align: 'right' }
                        );
                    }
                });

                // Baixar
                const timestamp = new Date().toISOString().slice(0, 10);
                doc.save(`Relatorio_Chamados_${timestamp}.pdf`);

                showReportStatus(`‚úÖ Relat√≥rio PDF gerado com sucesso! (${data.length} registros)`, 'success');

            } catch (error) {
                console.error('Erro ao exportar PDF:', error);
                showReportStatus(`‚ùå Erro ao exportar: ${error.message}`, 'error');
            }
        }

        // Gerar Relat√≥rio CSV
        async function generateCSVReport() {
            try {
                showReportStatus('üîÑ Gerando relat√≥rio CSV...', 'loading');
                
                const data = await loadReportData();

                if (data.length === 0) {
                    showReportStatus('‚ö†Ô∏è Nenhum dado encontrado para o relat√≥rio', 'error');
                    return;
                }

                // Preparar dados
                const headers = ['N¬∫ Pedido', 'Nota Fiscal', 'Transportadora', 'Cliente', 'Descri√ß√£o', 'Status', 'Situa√ß√£o', 'Respons√°vel Falha', 'Respons√°vel Resolu√ß√£o', 'Criado Por', 'Data'];
                const rows = data.map(occ => [
                    escapeCSV(occ.num_pedido),
                    escapeCSV(occ.nota_fiscal || '-'),
                    escapeCSV(occ.transportadora),
                    escapeCSV(occ.nome_cliente),
                    escapeCSV(occ.ocorrencia),
                    escapeCSV(occ.status),
                    escapeCSV(occ.situacao || '-'),
                    escapeCSV(occ.responsavel_falha || '-'),
                    escapeCSV(occ.responsavel_resolucao || '-'),
                    escapeCSV(occ.users?.name || 'Desconhecido'),
                    new Date(occ.created_at).toLocaleString('pt-BR')
                ]);

                // Montar CSV
                let csv = headers.join(',') + '\n';
                csv += rows.map(row => row.join(',')).join('\n');

                // Baixar
                downloadFile(csv, 'text/csv', `Relatorio_Chamados_${new Date().toISOString().slice(0, 10)}.csv`);

                showReportStatus(`‚úÖ Relat√≥rio CSV gerado com sucesso! (${data.length} registros)`, 'success');

            } catch (error) {
                console.error('Erro ao gerar CSV:', error);
                showReportStatus(`‚ùå Erro ao gerar relat√≥rio: ${error.message}`, 'error');
            }
        }

        // Gerar Relat√≥rio JSON
        async function generateJSONReport() {
            try {
                showReportStatus('üîÑ Gerando relat√≥rio JSON...', 'loading');
                
                const data = await loadReportData();

                if (data.length === 0) {
                    showReportStatus('‚ö†Ô∏è Nenhum dado encontrado para o relat√≥rio', 'error');
                    return;
                }

                // Estruturar dados
                const report = {
                    titulo: 'Relat√≥rio de Chamados - Fortimed',
                    dataGeracao: new Date().toLocaleString('pt-BR'),
                    totalRegistros: data.length,
                    chamados: data.map(occ => ({
                        numeroPedido: occ.num_pedido,
                        notaFiscal: occ.nota_fiscal || null,
                        transportadora: occ.transportadora,
                        cliente: occ.nome_cliente,
                        descricao: occ.ocorrencia,
                        status: occ.status,
                        situacao: occ.situacao || null,
                        responsavelFalha: occ.responsavel_falha || null,
                        responsavelResolucao: occ.responsavel_resolucao || null,
                        criadoPor: occ.users?.name || 'Desconhecido',
                        dataCriacao: new Date(occ.created_at).toISOString(),
                        dataUltimaAlteracao: new Date(occ.updated_at).toISOString()
                    }))
                };

                // Converter para JSON
                const jsonString = JSON.stringify(report, null, 2);

                // Baixar
                downloadFile(jsonString, 'application/json', `Relatorio_Chamados_${new Date().toISOString().slice(0, 10)}.json`);

                showReportStatus(`‚úÖ Relat√≥rio JSON gerado com sucesso! (${data.length} registros)`, 'success');

            } catch (error) {
                console.error('Erro ao gerar JSON:', error);
                showReportStatus(`‚ùå Erro ao gerar relat√≥rio: ${error.message}`, 'error');
            }
        }

        // Fun√ß√£o auxiliar: escapar CSV
        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const stringValue = String(value);
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                return '"' + stringValue.replace(/"/g, '""') + '"';
            }
            return stringValue;
        }

        // Fun√ß√£o auxiliar: escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
        }

        // Fun√ß√£o auxiliar: baixar arquivo
        function downloadFile(content, mimeType, filename) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:' + mimeType + ';charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // Fun√ß√£o para voltar
        function goBack() {
            window.location.href = 'index.html';
        }

        // Fun√ß√£o para carregar configura√ß√µes ao abrir a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            updateSystemStatus();
        });

        // Fun√ß√£o para copiar SQL do setup
        function copySetupSQL() {
            const sqlCode = document.getElementById('setupSQL');
            navigator.clipboard.writeText(sqlCode.textContent).then(() => {
                alert('‚úÖ SQL de setup copiado para a √°rea de transfer√™ncia!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('‚ùå Erro ao copiar. Por favor, copie manualmente.');
            });
        }

        // Fun√ß√£o para copiar SQL de limpeza
        function copyCleanupSQL() {
            const sqlCode = document.getElementById('cleanupSQL');
            navigator.clipboard.writeText(sqlCode.textContent).then(() => {
                alert('‚úÖ SQL de limpeza copiado para a √°rea de transfer√™ncia!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('‚ùå Erro ao copiar. Por favor, copie manualmente.');
            });
        }

        // Fun√ß√£o para copiar SQL de admin
        function copyAdminSQL() {
            const sqlCode = document.getElementById('adminSQL');
            navigator.clipboard.writeText(sqlCode.textContent).then(() => {
                alert('‚úÖ SQL de admin copiado para a √°rea de transfer√™ncia!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('‚ùå Erro ao copiar. Por favor, copie manualmente.');
            });
        }

        // Fun√ß√£o para atualizar status do sistema
        async function updateSystemStatus() {
            const statusInfo = document.getElementById('statusInfo');
            try {
                const client = config.getClient();
                
                // Testar conex√£o
                const { error } = await client
                    .from('occurrences')
                    .select('count', { count: 'exact', head: true });
                
                let html = '<div class="status-item">';
                if (!error) {
                    html += '<span class="status-ok">‚úÖ</span> <strong>Conex√£o com Banco:</strong> OK';
                } else {
                    html += '<span class="status-error">‚ùå</span> <strong>Conex√£o com Banco:</strong> Erro';
                }
                html += '</div>';

                // Verificar autentica√ß√£o
                const { data: { session } } = await client.auth.getSession();
                html += '<div class="status-item">';
                if (session) {
                    html += '<span class="status-ok">‚úÖ</span> <strong>Autentica√ß√£o:</strong> OK (' + session.user.email + ')';
                } else {
                    html += '<span class="status-warning">‚ö†Ô∏è</span> <strong>Autentica√ß√£o:</strong> N√£o autenticado';
                }
                html += '</div>';

                // Informa√ß√µes do usu√°rio
                const currentUser = authManager.getCurrentUser();
                html += '<div class="status-item">';
                if (currentUser) {
                    const role = currentUser.role === 'admin' ? 'üëë Admin' : 'üë§ Usu√°rio';
                    html += '<span class="status-ok">‚úÖ</span> <strong>Role:</strong> ' + role;
                } else {
                    html += '<span class="status-warning">‚ö†Ô∏è</span> <strong>Role:</strong> N√£o definido';
                }
                html += '</div>';

                statusInfo.innerHTML = html;
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                statusInfo.innerHTML = '<div class="status-item"><span class="status-error">‚ùå</span> Erro ao carregar status</div>';
            }
        }
    </script>
</body>
</html>
