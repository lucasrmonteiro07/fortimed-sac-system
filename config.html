<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes - Fortimed SAC</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <img src="/img/logo.png" alt="Fortimed Logo" class="logo" onerror="this.style.display='none'">
                    <h1>‚öôÔ∏è Configura√ß√µes - Fortimed SAC</h1>
                </div>
                <div class="user-info" id="userInfo">
                    <span id="userName"></span>
                    <button onclick="goBack()" class="btn-secondary">‚Üê Voltar</button>
                    <button onclick="logout()" class="btn-secondary">Sair</button>
                </div>
            </div>
        </header>

        <main class="config-page">
            <div class="form-container">
                <h2>‚öôÔ∏è Configura√ß√µes do Supabase</h2>
                <p class="info">Credenciais do banco de dados (somente leitura - sistema pr√©-configurado)</p>
                
                <form id="configForm" onsubmit="saveConfig(event)">
                    <div class="form-group">
                        <label for="supabaseUrl">Supabase URL:</label>
                        <input type="url" id="supabaseUrl" readonly placeholder="https://iowfcilmbeynrfszqlhu.supabase.co">
                        <small>URL do projeto Supabase</small>
                    </div>

                    <div class="form-group">
                        <label for="supabaseKey">Supabase Anon Key:</label>
                        <input type="password" id="supabaseKey" readonly placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
                        <small>Chave p√∫blica do Supabase (mascarada por seguran√ßa)</small>
                    </div>

                    <div class="form-actions">
                        <button type="button" onclick="testConnection()" class="btn-primary">üîå Testar Conex√£o</button>
                        <button type="button" onclick="loadConfig()" class="btn-secondary">üì• Carregar Configura√ß√µes</button>
                        <button type="button" onclick="goBack()" class="btn-secondary">‚Üê Voltar</button>
                    </div>
                </form>

                <div id="testResult" class="test-result"></div>

                <!-- Se√ß√£o de Informa√ß√µes do Banco -->
                <div class="database-info">
                    <h3>üìä Estrutura do Banco de Dados</h3>
                    <p>Se voc√™ precisa recriar as tabelas, execute este SQL no seu Supabase SQL Editor:</p>
                    
                    <div class="sql-section">
                        <h4>‚úÖ Setup Recomendado (Executar no Supabase):</h4>
                        <button onclick="copySetupSQL()" class="btn-secondary btn-sm">üìã Copiar Setup</button>
                        <pre><code id="setupSQL">-- ============================================================================
-- FORTIMED - CONFIGURA√á√ÉO SIMPLIFICADA DO BANCO DE DADOS
-- Execute este script no Supabase SQL Editor
-- ============================================================================

-- 1. Criar tabela de usu√°rios para controle de roles
CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    role VARCHAR(50) DEFAULT 'user',
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. Criar tabela de ocorr√™ncias
CREATE TABLE IF NOT EXISTS occurrences (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    num_pedido VARCHAR(100) NOT NULL,
    nota_fiscal VARCHAR(100),
    transportadora VARCHAR(255) NOT NULL,
    nome_cliente VARCHAR(255) NOT NULL,
    ocorrencia TEXT NOT NULL,
    status VARCHAR(50) NOT NULL,
    situacao TEXT,
    responsavel_falha VARCHAR(255),
    responsavel_resolucao VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    created_by UUID REFERENCES users(id)
);

-- 3. Habilitar RLS na tabela occurrences
ALTER TABLE occurrences ENABLE ROW LEVEL SECURITY;

-- 4. Remover todas as pol√≠ticas existentes
DROP POLICY IF EXISTS "Usu√°rios veem apenas suas ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios podem criar ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios atualizam apenas suas ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios deletam apenas suas ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Admin v√™ todas as ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios veem suas pr√≥prias ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Admin pode fazer qualquer coisa" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios autenticados podem ver ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios autenticados podem criar ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios autenticados podem atualizar ocorr√™ncias" ON occurrences;
DROP POLICY IF EXISTS "Usu√°rios autenticados podem deletar ocorr√™ncias" ON occurrences;

-- 5. Criar pol√≠ticas RLS com controle de admin
-- Admin pode ver todas as ocorr√™ncias
CREATE POLICY "Admin v√™ todas as ocorr√™ncias"
    ON occurrences FOR SELECT
    USING (
        EXISTS(
            SELECT 1 FROM users
            WHERE users.id = auth.uid()
            AND users.role = 'admin'
        )
    );

-- Usu√°rios normais veem apenas suas ocorr√™ncias
CREATE POLICY "Usu√°rios veem suas pr√≥prias ocorr√™ncias"
    ON occurrences FOR SELECT
    USING (created_by = auth.uid());

-- Permitir inser√ß√£o para usu√°rios autenticados
CREATE POLICY "Usu√°rios autenticados podem criar ocorr√™ncias"
    ON occurrences FOR INSERT
    WITH CHECK (auth.role() = 'authenticated');

-- Permitir atualiza√ß√£o para admin ou criador
CREATE POLICY "Usu√°rios e admin podem atualizar ocorr√™ncias"
    ON occurrences FOR UPDATE
    USING (
        created_by = auth.uid() OR
        EXISTS(
            SELECT 1 FROM users
            WHERE users.id = auth.uid()
            AND users.role = 'admin'
        )
    );

-- Permitir deleta√ß√£o para admin ou criador
CREATE POLICY "Usu√°rios e admin podem deletar ocorr√™ncias"
    ON occurrences FOR DELETE
    USING (
        created_by = auth.uid() OR
        EXISTS(
            SELECT 1 FROM users
            WHERE users.id = auth.uid()
            AND users.role = 'admin'
        )
    );

-- 6. Criar √≠ndices para melhor performance
CREATE INDEX IF NOT EXISTS idx_occurrences_num_pedido ON occurrences(num_pedido);
CREATE INDEX IF NOT EXISTS idx_occurrences_status ON occurrences(status);
CREATE INDEX IF NOT EXISTS idx_occurrences_created_at ON occurrences(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_occurrences_created_by ON occurrences(created_by);
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);

-- ============================================================================
-- FORTIMED DATABASE SETUP COMPLETE ‚úÖ
-- ============================================================================</code></pre>
                    </div>

                    <!-- Se√ß√£o de Limpeza de Duplicatas -->
                    <div class="sql-section">
                        <h4>üßπ Limpar Duplicatas (se necess√°rio):</h4>
                        <button onclick="copyCleanupSQL()" class="btn-secondary btn-sm">üìã Copiar Limpeza</button>
                        <pre><code id="cleanupSQL">-- Remove ocorr√™ncias duplicadas, mantendo apenas a mais recente
DELETE FROM occurrences
WHERE id NOT IN (
    SELECT MAX(id) FROM occurrences
    GROUP BY num_pedido, nome_cliente, transportadora
);

-- Verifica resultado
SELECT COUNT(*) as total_occurrences FROM occurrences;</code></pre>
                    </div>

                    <!-- Se√ß√£o de Admin -->
                    <div class="sql-section">
                        <h4>üëë Configurar Admin (se necess√°rio):</h4>
                        <button onclick="copyAdminSQL()" class="btn-secondary btn-sm">üìã Copiar Admin</button>
                        <pre><code id="adminSQL">-- Atualizar um usu√°rio para admin
UPDATE users
SET role = 'admin'
WHERE email = 'administrativo@fortimeddistribuidora.com.br';

-- Verificar usu√°rios e roles
SELECT id, email, name, role, created_at FROM users ORDER BY created_at DESC;</code></pre>
                    </div>
                </div>

                <!-- Status do Sistema -->
                <div class="system-status">
                    <h3>üîç Status do Sistema</h3>
                    <div id="statusInfo" class="status-list">
                        <p>Carregando informa√ß√µes...</p>
                    </div>
                </div>

                <!-- Se√ß√£o de Relat√≥rios - MOVIDO PARA relatorios.html -->

                <!-- Informa√ß√µes √öteis -->
                <div class="helpful-info">
                    <h3>‚ÑπÔ∏è Informa√ß√µes √öteis</h3>
                    <ul>
                        <li><strong>Usu√°rios Padr√£o:</strong>
                            <ul>
                                <li>Admin: administrativo@fortimeddistribuidora.com.br (Compras@01)</li>
                                <li>Vendas: vendas01@fortimeddistribuidora.com.br at√© vendas06@</li>
                            </ul>
                        </li>
                        <li><strong>Funcionalidades:</strong>
                            <ul>
                                <li>Admin v√™ todos os chamados</li>
                                <li>Usu√°rios normais veem apenas seus chamados</li>
                                <li>Cria√ß√£o, edi√ß√£o e exclus√£o de ocorr√™ncias</li>
                                <li>Filtros e busca por n√∫mero do pedido, cliente ou transportadora</li>
                            </ul>
                        </li>
                        <li><strong>Documenta√ß√£o:</strong>
                            <ul>
                                <li>Solu√ß√£o R√°pida: <code>SOLUCAO-RAPIDA.md</code></li>
                                <li>Solu√ß√£o Admin: <code>SOLUCAO-ADMIN.md</code></li>
                                <li>README Principal: <code>README.md</code></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        // Fun√ß√£o para voltar
        function goBack() {
            window.location.href = '/index.html';
        }

        // Fun√ß√£o para carregar configura√ß√µes ao abrir a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            updateSystemStatus();
        });

        // Fun√ß√£o para copiar SQL do setup
        function copySetupSQL() {
            const sqlCode = document.getElementById('setupSQL');
            navigator.clipboard.writeText(sqlCode.textContent).then(() => {
                alert('‚úÖ SQL de setup copiado para a √°rea de transfer√™ncia!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('‚ùå Erro ao copiar. Por favor, copie manualmente.');
            });
        }

        // Fun√ß√£o para copiar SQL de limpeza
        function copyCleanupSQL() {
            const sqlCode = document.getElementById('cleanupSQL');
            navigator.clipboard.writeText(sqlCode.textContent).then(() => {
                alert('‚úÖ SQL de limpeza copiado para a √°rea de transfer√™ncia!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('‚ùå Erro ao copiar. Por favor, copie manualmente.');
            });
        }

        // Fun√ß√£o para copiar SQL de admin
        function copyAdminSQL() {
            const sqlCode = document.getElementById('adminSQL');
            navigator.clipboard.writeText(sqlCode.textContent).then(() => {
                alert('‚úÖ SQL de admin copiado para a √°rea de transfer√™ncia!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('‚ùå Erro ao copiar. Por favor, copie manualmente.');
            });
        }

        // Fun√ß√£o para atualizar status do sistema
        async function updateSystemStatus() {
            const statusInfo = document.getElementById('statusInfo');
            try {
                const client = config.getClient();
                
                // Testar conex√£o
                const { error } = await client
                    .from('occurrences')
                    .select('count', { count: 'exact', head: true });
                
                let html = '<div class="status-item">';
                if (!error) {
                    html += '<span class="status-ok">‚úÖ</span> <strong>Conex√£o com Banco:</strong> OK';
                } else {
                    html += '<span class="status-error">‚ùå</span> <strong>Conex√£o com Banco:</strong> Erro';
                }
                html += '</div>';

                // Verificar autentica√ß√£o
                const { data: { session } } = await client.auth.getSession();
                html += '<div class="status-item">';
                if (session) {
                    html += '<span class="status-ok">‚úÖ</span> <strong>Autentica√ß√£o:</strong> OK (' + session.user.email + ')';
                } else {
                    html += '<span class="status-warning">‚ö†Ô∏è</span> <strong>Autentica√ß√£o:</strong> N√£o autenticado';
                }
                html += '</div>';

                // Informa√ß√µes do usu√°rio
                const currentUser = authManager.getCurrentUser();
                html += '<div class="status-item">';
                if (currentUser) {
                    const role = currentUser.role === 'admin' ? 'üëë Admin' : 'üë§ Usu√°rio';
                    html += '<span class="status-ok">‚úÖ</span> <strong>Role:</strong> ' + role;
                } else {
                    html += '<span class="status-warning">‚ö†Ô∏è</span> <strong>Role:</strong> N√£o definido';
                }
                html += '</div>';

                statusInfo.innerHTML = html;
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                statusInfo.innerHTML = '<div class="status-item"><span class="status-error">‚ùå</span> Erro ao carregar status</div>';
            }
        }
    </script>
</body>
</html>
